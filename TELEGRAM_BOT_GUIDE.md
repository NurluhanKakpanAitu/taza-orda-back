# Руководство по запуску Telegram бота TazaOrda

## Обзор

Telegram бот для TazaOrda предоставляет пользователям удобный интерфейс для:
- Регистрации в системе
- Создания обращений о проблемах с чистотой
- Просмотра и участия в событиях (субботниках)
- Получения уведомлений

Администраторы получают дополнительные возможности для управления обращениями.

## Предварительные требования

1. **Telegram бот токен**
   - Создайте бота через [@BotFather](https://t.me/BotFather)
   - Отправьте `/newbot` и следуйте инструкциям
   - Сохраните полученный токен (выглядит как `123456789:ABCdefGhIJKlmNoPQRsTUVwxyZ`)

2. **Ваш Chat ID (для админ-функций)**
   - Отправьте сообщение боту [@userinfobot](https://t.me/userinfobot)
   - Скопируйте ваш Chat ID (число, например `125691222`)

## Настройка

### Вариант 1: Локальный запуск

#### 1. Установка зависимостей

```bash
cd Presentation/TazaOrda.TelegramBot
dotnet restore
```

#### 2. Конфигурация

Отредактируйте `appsettings.json`:

```json
{
  "TelegramBot": {
    "Token": "ВСТАВЬТЕ_ВАШ_ТОКЕН_СЮДА",
    "AdminChatId": 125691222,
    "AdminIds": [125691222],
    "ApiBaseUrl": "http://localhost:8080"
  }
}
```

Или используйте переменные окружения:

```bash
export TelegramBot__Token="ваш_токен"
export TelegramBot__AdminChatId="125691222"
```

#### 3. Запуск API (в отдельном терминале)

```bash
cd Presentation/TazaOrda.API
dotnet run
```

#### 4. Запуск бота

```bash
cd Presentation/TazaOrda.TelegramBot
dotnet run
```

При успешном запуске вы увидите:
```
info: TelegramBotHostedService[0]
      Telegram бот запущен: @ваш_бот_username
```

### Вариант 2: Docker Compose

#### 1. Настройка токена

Создайте или отредактируйте файл `.env` в корне проекта:

```bash
TELEGRAM_BOT_TOKEN=ваш_токен_бота
```

#### 2. Запуск всех сервисов

```bash
docker-compose up -d
```

Это запустит:
- PostgreSQL (база данных)
- MinIO (хранилище файлов)
- API TazaOrda
- Telegram бот

#### 3. Проверка логов

```bash
# Логи бота
docker logs -f tazaorda-telegram-bot

# Логи API
docker logs -f tazaorda-api
```

#### 4. Остановка

```bash
docker-compose down
```

## Использование бота

### Для обычных пользователей:

1. **Регистрация**
   ```
   /start
   /register
   ```
   - Введите имя и фамилию
   - Отправьте номер телефона

2. **Создание обращения**
   ```
   /report
   ```
   - Выберите категорию проблемы
   - Опишите проблему
   - Отправьте геолокацию
   - Отправьте фото (опционально)

3. **Просмотр обращений**
   ```
   /myreports
   ```

4. **События**
   ```
   /events - список активных событий
   /myevents - ваши события
   ```

5. **Помощь**
   ```
   /help
   /cancel - отменить текущую операцию
   ```

### Для администраторов:

Администраторы (с ID из `AdminIds`) получают дополнительные возможности:

1. **Админ-панель**
   ```
   /admin
   ```

2. **Уведомления**
   - Бот автоматически отправляет уведомления о новых обращениях в чат с ID `AdminChatId`
   - Можно сразу принять или отклонить обращение через кнопки

## Команды бота

### Основные команды

| Команда | Описание |
|---------|----------|
| `/start` | Главное меню и приветствие |
| `/register` | Регистрация в системе |
| `/report` | Создать обращение |
| `/myreports` | Список моих обращений |
| `/events` | Активные события |
| `/myevents` | Мои события |
| `/help` | Справка |
| `/cancel` | Отменить текущую операцию |

### Админ-команды

| Команда | Описание |
|---------|----------|
| `/admin` | Панель администратора |

## Архитектура бота

```
TazaOrda.TelegramBot/
├── Configuration/
│   └── BotConfiguration.cs      # Настройки (токен, админы)
├── Handlers/
│   └── UpdateHandler.cs         # Обработка сообщений
├── Models/
│   └── UserState.cs             # Модели состояний
├── Services/
│   ├── StateManager.cs          # Управление состояниями
│   └── TazaOrdaApiClient.cs     # HTTP клиент для API
└── Program.cs                   # Точка входа
```

## Функциональность

### 1. Регистрация пользователей
- Сбор имени и фамилии
- Верификация номера телефона
- Создание аккаунта через API
- Сохранение токена для последующих запросов

### 2. Создание обращений
- Выбор категории (переполненный контейнер, свалка, и т.д.)
- Описание проблемы
- Отправка геолокации
- Прикрепление фото (опционально)
- Уведомление администратора

### 3. События
- Просмотр активных событий
- Подписка на события
- Отписка от событий
- Просмотр своих событий

### 4. Админ-панель
- Уведомления о новых обращениях
- Быстрые действия (принять/отклонить)
- Статистика (в разработке)

## Управление состоянием

Бот использует state machine для отслеживания диалогов:

```
None → AwaitingRegistrationName → AwaitingRegistrationPhone → Done
None → AwaitingReportCategory → AwaitingReportDescription → AwaitingReportLocation → AwaitingReportPhoto → Done
```

Состояния хранятся в памяти и автоматически очищаются через 24 часа неактивности.

## Безопасность

### Важно для production:

1. **Храните токен в безопасности**
   - Не коммитьте `.env` в git
   - Используйте переменные окружения или secret manager

2. **Используйте HTTPS для API**
   - В production API должен быть доступен по HTTPS
   - Обновите `ApiBaseUrl` соответственно

3. **Рассмотрите использование Redis**
   - Для хранения состояний пользователей
   - Для масштабирования на несколько инстансов

4. **Настройте rate limiting**
   - Защита от спама
   - Ограничение количества запросов

## Мониторинг

### Логи

Бот логирует:
- Запуск/остановку
- Все входящие сообщения
- Ошибки обработки
- Ошибки API

### Проверка работоспособности

```bash
# Проверка, что бот запущен
docker ps | grep telegram-bot

# Логи в реальном времени
docker logs -f tazaorda-telegram-bot

# Последние 100 строк
docker logs --tail 100 tazaorda-telegram-bot
```

## Troubleshooting

### Бот не отвечает

1. Проверьте, запущен ли бот:
   ```bash
   docker ps | grep telegram-bot
   ```

2. Проверьте логи:
   ```bash
   docker logs tazaorda-telegram-bot
   ```

3. Проверьте токен в конфигурации

### Ошибки при создании обращений

1. Проверьте, что API доступен:
   ```bash
   curl http://localhost:8080/health
   ```

2. Проверьте правильность `ApiBaseUrl` в конфигурации

3. Проверьте, что пользователь зарегистрирован

### Админ-панель недоступна

1. Проверьте, что ваш Chat ID добавлен в `AdminIds`
2. Перезапустите бота после изменения конфигурации

## Дальнейшее развитие

### Планируемые функции:

- [ ] Уведомления об изменении статуса обращения
- [ ] Напоминания о предстоящих событиях
- [ ] Геймификация (рейтинг, достижения)
- [ ] Локализация (казахский язык)
- [ ] Webhook вместо long polling
- [ ] Интеграция с Redis для состояний
- [ ] Rate limiting
- [ ] Inline-режим для быстрых обращений

### Технические улучшения:

- [ ] Application Insights / Serilog
- [ ] Health checks endpoint
- [ ] Prometheus metrics
- [ ] Distributed tracing
- [ ] Circuit breaker для API запросов
- [ ] Retry policies

## Поддержка

При возникновении проблем:

1. Проверьте логи бота и API
2. Убедитесь, что все сервисы запущены
3. Проверьте конфигурацию
4. Создайте issue в репозитории с описанием проблемы

## Лицензия

Proprietary - TazaOrda Project